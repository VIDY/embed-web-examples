// imported file ~> vidy/embed.js/dist/embed.es.js
var TOKEN_KEY="vidy:sdk:token",TOKEN=getToken();function headers(){var e={};return TOKEN&&(e.authorization="Bearer "+TOKEN),e["content-type"]="application/json;charset=UTF-8",e}function send(e,t,n,a){return(a=a||{}).method=e,a.headers=headers(),n&&(a.body=JSON.stringify(n)),fetch("https://api.vidy.sh/"+t,a)}var get=send.bind(null,"get"),post=send.bind(null,"post"),put=send.bind(null,"put");function getToken(){return localStorage.getItem(TOKEN_KEY)||!1}function setToken(e){localStorage.setItem(TOKEN_KEY,TOKEN=e)}function isUser(){return!!TOKEN}var DOC=document,create=DOC.createElement.bind(DOC),append=function(e,t){return e.appendChild(t)},NS=DOC.createElementNS.bind(DOC,"http://www.w3.org/2000/svg"),AVA_URI="https://tinyfac.es/data/avatars/",AVATARS=["A7299C8E-CEFC-47D9-939A-3C8CA0EA4D13-200w.jpeg","03F55412-DE8A-4F83-AAA6-D67EE5CE48DA-200w.jpeg","E0B4CAB3-F491-4322-BEF2-208B46748D4A-200w.jpeg","852EC6E1-347C-4187-9D42-DF264CCF17BF-200w.jpeg","2DDDE973-40EC-4004-ABC0-73FD4CD6D042-200w.jpeg","BA0CB1F2-8C79-4376-B13B-DD5FB8772537-200w.jpeg","5F8C5D50-DDB6-4F06-AA15-ACB30D8D910D-200w.jpeg","FBEBF655-4886-455A-A4A4-D62B77DD419B-200w.jpeg","7E570445-25F0-4276-8E8F-084ABA2C8FB8-200w.jpeg","B3CF5288-34B0-4A5E-9877-5965522529D6-200w.jpeg","26CFEFB3-21C8-49FC-8C19-8E6A62B6D2E0-200w.jpeg"];function acceptNode(e){return!/script|style/i.test(e.parentNode.nodeName)}function toEntry(e){var t=e.phrase.split("/");return{id:e.id,text:t[0],count:parseInt(t[1],10),regexp:RegExp(t[0],"gi")}}function toLocation(e,t,n){return 0==n?e.indexOf(t):e.indexOf(t,toLocation(e,t,--n)+1)}function toCenterCoords(){return{clientX:window.innerWidth/2,clientY:window.innerHeight/2-60}}function index(e){var t,n,a,i,o,s,r,c,d,l,u,p,m,v,f,g,h,E,y,A,D=this;if(!(e=e||{}).appid||!e.postid)return console.error('[VIDY] An "appid" and a "postid" are required!');function C(e){s.style.visibility=e?"visible":"hidden"}function w(e){var t="touchstart"===e.type||"touchmove"===e.type?e.touches[0].clientX:e.clientX,n="touchstart"===e.type||"touchmove"===e.type?e.touches[0].clientY:e.clientY;n=n>210?n-210:n+20,r.style.transform=d.style.transform="translate("+(t-100)+"px,"+n+"px)",(A||{}).y||(A={x:t,y:n}),"touchmove"===e.type&&n+100<A.y&&k(e)}function N(){v.pause(),clearTimeout(o),o=null,s.removeEventListener("click",_),l.className="vidy-login",s.className="vidy",setTimeout(C,250),m.removeAttribute("style"),f.textContent="",A={},y=Date.now()}function _(e){e.target.classList.contains("vidy")&&(s.className+=" exit",setTimeout(N,600))}function T(e){e.target.removeEventListener("mousemove",w),N()}function b(e){if(("Escape"==e.key||"Esc"==e.key||27==e.keyCode)&&"BODY"==e.target.nodeName)return window.removeEventListener("keydown",b),e.preventDefault(),N(),!1}function k(e){var t=e.target.closest(".vlink");w(O),s.classList.add("swipe",t._type),C(!0),d.removeAttribute("style"),s.addEventListener("click",_),f.textContent=t._views_total.toLocaleString()+" views",t.removeEventListener("mousemove",w),t.removeEventListener("mouseleave",T),window.addEventListener("keydown",b)}var O=toCenterCoords();D.nodes=function(e){for(var t,n=[],a=DOC.createTreeWalker(e,4,{acceptNode:acceptNode});t=a.nextNode();)t.data.trim().length>0&&n.push(t);return n},D.after=function(e,t){e.parentNode.insertBefore(t,e.nextSibling)},D.init=function(n){return D.appid=e.appid,D.postid=n||e.postid,r||((s=create("div")).className="vidy",(r=create("div")).className="vidy-player",(t=create("div")).className="vidy-mask circle",append(t,v=create("video")),append(r,t),(t=create("div")).className="vidy-social",append(t,f=create("figure")),append(t,u=socials()),append(r,t),u._comment.onclick=function(e){if(!isUser())return l.enter();console.log("> TODO: comment")},u._like.onclick=function(e){if(!isUser())return l.enter();var t=u.classList;put("clips/"+u._clip+"/likes",{value:!t.contains("liked")}).then(function(e){return e.json()}).then(function(e){t.toggle("liked",v._vlink._user_likes=e.value)})},append(s,r),(d=create("div")).className="vidy-profile",(t=create("div")).className="vidy-avatar",append(append(t,NS("svg")),m=NS("circle")),append(t,p=create("img")),append(d,t),append(s,d),v.pause=v.pause.bind(v),v.play=v.play.bind(v),v.ontimeupdate=function(){m.style.strokeDashoffset=Math.max(100*(1-v.currentTime/v.duration),0)},E||(v.onpause=function(){console.log("> video paused",1e3*v.currentTime),post(h+"/views",{embed:v._embed,duration:1e3*v.currentTime}),!isUser()&&/advert/.test(s.className)&&console.log("> PROMPT LOGIN/REGISTER :: CLAIM CREDITSÂ FOR ADVERTISEMENT")},v.onended=function(){console.log("> video ended; manual loop"),v._vlink.classList.add("viewed")},(c=create("div")).className="vidy-avatar vidy-account",append(c,t=create("img")),isUser()?t.src=AVA_URI+AVATARS[0]:(t.src="#",append(s,l=form()),l.onsubmit=function(e){e.preventDefault();var t=l.elements;post("auth/login",{email:t[0].value,password:t[1].value}).then(function(e){return e.json()}).then(function(e){c.firstChild.src=AVA_URI+AVATARS[0],l.className="vidy-login",setToken(e.data.token),l.reset()})}),append(s,c)),append(DOC.body,s)),get(h="apps/"+D.appid+"/content/"+D.postid).then(function(t){return t.json().then(function(t){var n,o,s;if((a=t.data||[]).forEach(function(e){e.clip&&(e.clip.account.avatar=AVA_URI+AVATARS[Math.floor(Math.random()*AVATARS.length)])}),i=a.map(toEntry),!E&&a.length)return post("history",{embeds:a.map(function(e){return e.id})}).then(function(t){return t.json().then(function(t){i.forEach(function(e){for(o in n=t.data[e.id])for(s in n[o])e[s+"_"+o]=n[o][s]}),e.autoload&&D.load()})});(E||e.autoload)&&D.load()})})},D.draw=function(e,i,r){var c=i.text,d=toLocation(e.data,c,r||0),l=i.embed||a.find(function(e){return e.id===i.id}),m=l.clip;console.time('draw "'+c+'"');var f=e.data.substring(d+c.length),g=create("span");if(g.className="vlink",i.user_views>=m.duration&&(g.className+=" viewed"),g._embed=l.id,g._type=m.sponsored?"advert":"social",g._views_total=i.total_views||0,g._likes_total=i.total_likes||0,g._user_likes=!!i.user_likes,g.onmouseenter=function(e){y>Date.now()-250||s.classList.contains("open")||(w(e),v._vlink=g,g.addEventListener("mouseleave",T),u._clip=m.id,u.classList.toggle("liked",g._user_likes),v._embed=u._embed=g._embed,p.src=m.account.avatar,v.src=m.files.landscapeVideo240.url,v.poster=m.files.landscapeImage240.url,o=setTimeout(function(){C(!0),s.classList.add("hover"),clearTimeout(o),o=null,g.addEventListener("mousemove",w),E||g.addEventListener("click",k),setTimeout(v.play,250)},250))},g.ontouchstart=function(e){w(e),v._embed=g._embed,v.src=l.clip.files.landscapeVideo240.url,v.poster=l.clip.files.landscapeImage240.url,g.ontouchmove=function(e){return w(e)},g.ontouchend=function(e){s.classList.contains("swipe")||N()},o=setTimeout(function(){C(!0),s.classList.add("open"),clearTimeout(o),o=null,setTimeout(v.play,250)},250)},(t=create("span")).innerText=c,append(g,t),append(g,create("i")),e.data=e.data.substring(0,d),D.after(e,g),f.length>0){var h=n.indexOf(e)+1,A=DOC.createTextNode(f);D.after(g,A),n.splice(h,0,A)}return console.timeEnd('draw "'+c+'"'),g},D.load=function(){n=D.nodes(D.base=DOC.querySelector(e.content||"body")),console.time("load");for(var t,a,o,s=0,r=0;i.length>0;)for(a=i.shift(),s=0;s<n.length&&(t=n[s],!(a.count<0));s++)if(o=t.data.match(a.regexp))for(r=0;r<o.length;r++)if(--a.count<0){D.draw(t,a,r);break}console.timeEnd("load")},(g=DOC.referrer)&&((t=create("a")).href=g,E="https://demo-dash-jbdigsngwo.now.sh"===(g=t.origin)),this.init()}function form(){var e,t=create("form");return t.className="vidy-login",t.onsubmit=prevent,append(t,input("email","Email Address")),append(t,input("password")),(e=create("button")).type="submit",e.textContent="Login",append(t,e),t.enter=function(){t.className+=" show",setTimeout(function(){t.elements[0].focus()},150)},t}function input(e,t){var n,a=create("div");return a.className="v-input",(n=create("label")).textContent=t||e,append(a,n),(n=create("input")).name=n.type=e,append(a,n),a}function socials(){var e=create("div");return e.className="vidy-btns",append(e,e._like=create("button")).className="v-like",append(e,e._comment=create("button")).className="v-comment",append(e,e._share=create("button")).className="v-share",e}function prevent(e){e.preventDefault(),e.stopPropagation()}export default index;
